// ==============================
// ISLAMIC RESOURCE HUB LAYOUT INJECTOR
// - Injects header + mobile drawer
// - Injects footer + back-to-top
// - Handles mobile menu
// - Header is FIXED (sticky) on scroll
// ==============================
document.addEventListener("DOMContentLoaded", () => {
  console.log("islamic-layout.js loaded");

  // 0) Inject favicon (applies to every page that loads this script)
  (function addFavicon() {
    const existing = document.querySelector('link[rel~="icon"]');
    if (!existing) {
      const link = document.createElement("link");
      link.rel = "icon";
      link.type = "image/png";
      // üîß Update this to your Islamic Resource Hub favicon path
      link.href = "images/irh-icon.png";
      document.head.appendChild(link);
    }
  })();

  // 1) Inject shared styles (mobile nav + icon buttons + back-to-top + fixed header offset)
  const style = document.createElement("style");
  style.textContent = `
    .mobile-nav{display:flex;flex-direction:column;gap:.25rem}
    .mobile-link{display:block;padding:.5rem 0;font-weight:600}
    .mobile-section{margin-top:.5rem;border-top:1px solid rgba(255,255,255,.08);padding-top:1rem}

    .icon-btn{
      width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;
      border-radius:.375rem;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);
      transition:all .2s
    }
    .icon-btn:hover{border-color:rgba(228,0,127,.6);color:rgb(244,114,182)}

    /* Back-to-top button */
    .back-to-top{
      position: fixed;
      right: 16px;
      bottom: calc(env(safe-area-inset-bottom, 0) + 16px);
      width: 46px; height: 46px;
      display: flex; align-items: center; justify-content: center;
      background: #fff; color: #111;
      border: 1px solid rgba(0,0,0,.15);
      border-radius: .5rem;
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      z-index: 30;
      cursor: pointer;
      font-size: 22px; line-height: 1;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      opacity: 0; visibility: hidden; transform: translateY(8px);
      transition: opacity .2s ease, transform .2s ease, visibility .2s ease;
    }
    .back-to-top:hover{ filter: brightness(.95); }
    .back-to-top:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(228,0,127,.35), 0 10px 20px rgba(0,0,0,.25);
    }
    .back-to-top.show{ opacity: 1; visibility: visible; transform: none; }
    @media (max-width:640px){
      .back-to-top{ right: 12px; width: 44px; height: 44px; }
    }
    body.menu-open .back-to-top{
      opacity: 0 !important;
      visibility: hidden !important;
      pointer-events: none !important;
    }

    /* Push content down so it's not hidden under fixed header */
    body.with-fixed-header{
      padding-top: var(--header-offset, 80px);
    }
  `;
  document.head.appendChild(style);

  // 2) Inject HEADER + MOBILE DRAWER (header is FIXED)
  const headerHtml = `
<header class="site-header fixed top-0 left-0 right-0 flex items-center justify-between px-4 md:px-8 py-3 md:py-4 z-50 bg-black/95 text-white border-b border-pink-500/30 backdrop-blur">
  <!-- LOGO / TITLE -->
  <a href="index.html" class="flex items-center gap-2">
    <div class="flex items-center justify-center w-9 h-9 rounded-full bg-pink-600 text-xs font-black tracking-tight">
      IRH
    </div>
    <div class="leading-tight">
      <div class="text-sm md:text-base font-extrabold tracking-wide uppercase">Islamic Resource Hub</div>
      <div class="text-[11px] md:text-xs text-pink-200/80 hidden sm:block">Dhikr ‚Ä¢ Qasidah ‚Ä¢ Nasheed</div>
    </div>
  </a>

  <!-- DESKTOP NAV -->
  <nav class="hidden md:flex items-center space-x-6 text-sm font-medium">
    <a href="#downloads" class="hover:text-pink-300 transition" data-nav="downloads">Downloads</a>
    <a href="#about" class="hover:text-pink-300 transition" data-nav="about">About</a>
    <a href="#contact" class="hover:text-pink-300 transition" data-nav="contact">Contact</a>
    <a href="https://iederees-create.github.io/justine_shop/" target="_blank" rel="noopener" class="hover:text-pink-300 transition" data-nav="shop">
      Avon + Justine Shop
    </a>
  </nav>

  <!-- DESKTOP ICONS (optional) -->
  <div class="hidden md:flex items-center space-x-3">
    <button aria-label="Support" class="icon-btn text-sm">‚ù§Ô∏è</button>
  </div>

  <!-- MOBILE MENU BUTTON -->
  <button id="mobile-menu-button" class="md:hidden text-3xl z-50" aria-label="Open menu">‚ò∞</button>
</header>

<!-- OVERLAY -->
<div id="overlay" class="fixed inset-0 bg-black/60 hidden z-40"></div>

<!-- MOBILE DRAWER -->
<div
  id="mobile-menu"
  class="fixed top-0 right-0 w-3/4 sm:w-80 h-full bg-[#050509] text-white p-6 transform translate-x-full transition-transform duration-300 z-50 overflow-y-auto shadow-2xl"
>
  <div class="flex items-start justify-between mb-6">
    <div>
      <div class="text-sm font-semibold uppercase tracking-wide text-pink-300">Islamic Resource Hub</div>
      <div class="text-xs text-pink-200/80 mt-1">Dhikr ‚Ä¢ Qasidah ‚Ä¢ Nasheed</div>
    </div>
    <button id="close-menu" class="text-2xl leading-none p-1 rounded hover:bg-white/10" aria-label="Close menu">‚úï</button>
  </div>

  <nav class="mobile-nav text-[15px]">
    <a href="#downloads" class="mobile-link" data-nav="downloads">Downloads</a>
    <a href="#about" class="mobile-link" data-nav="about">About</a>
    <a href="#contact" class="mobile-link" data-nav="contact">Contact</a>
    <a href="https://iederees-create.github.io/justine_shop/" target="_blank" rel="noopener" class="mobile-link" data-nav="shop">
      Avon + Justine Shop
    </a>
  </nav>
</div>
`;
  document.body.insertAdjacentHTML("afterbegin", headerHtml);

  // 3) Inject FOOTER + back-to-top
  const footerHtml = `
<footer class="footer bg-[#111111] text-gray-200 mt-10">
  <div class="max-w-4xl mx-auto px-4 py-10 text-center space-y-4">
    <p class="text-sm md:text-base text-gray-300">
      Curated Islamic audio and resources for the Ummah ‚Äî dhikr, qasidah, nasheed, and more.
    </p>
    <p class="text-xs text-gray-400">
      Please use these resources with respect and adab. Support your local scholars and communities.
    </p>
  </div>
  <div class="bg-black text-gray-300 text-xs border-t border-pink-500/30">
    <div class="max-w-5xl mx-auto px-4 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <span>¬© <span id="year"></span> Islamic Resource Hub ‚Äî by Iederees Francis</span>
      <span class="text-gray-400">All rights reserved.</span>
    </div>
  </div>
</footer>

<button id="backToTop" class="back-to-top" aria-label="Back to top" title="Back to top" type="button">‚Üë</button>
`;
  document.body.insertAdjacentHTML("beforeend", footerHtml);

  // 4) Make room for the FIXED header (calculate height & set CSS var)
  const headerEl = document.querySelector(".site-header");
  if (headerEl) {
    document.body.classList.add("with-fixed-header");
    const adjustHeaderOffset = () => {
      const h = headerEl.offsetHeight || 0;
      document.documentElement.style.setProperty("--header-offset", h + "px");
    };
    window.addEventListener("load", adjustHeaderOffset);
    window.addEventListener("resize", adjustHeaderOffset);
    adjustHeaderOffset();
  }

  // 5) Behavior: footer year
  const yearSpan = document.getElementById("year");
  if (yearSpan) yearSpan.textContent = new Date().getFullYear();

  // 6) Behavior: mobile menu
  const openBtn    = document.getElementById("mobile-menu-button");
  const closeBtn   = document.getElementById("close-menu");
  const mobileMenu = document.getElementById("mobile-menu");
  const overlay    = document.getElementById("overlay");

  function openMenu(){
    if (!mobileMenu || !overlay) return;
    mobileMenu.classList.remove("translate-x-full");
    overlay.classList.remove("hidden");
    document.body.style.overflow = "hidden";
    document.body.classList.add("menu-open");
  }

  function closeMenu(){
    if (!mobileMenu || !overlay) return;
    mobileMenu.classList.add("translate-x-full");
    overlay.classList.add("hidden");
    document.body.style.overflow = "";
    document.body.classList.remove("menu-open");
  }

  if (openBtn)  openBtn.addEventListener("click", openMenu);
  if (closeBtn) closeBtn.addEventListener("click", closeMenu);
  if (overlay)  overlay.addEventListener("click", closeMenu);

  document.addEventListener("keydown", e => {
    if (e.key === "Escape") closeMenu();
  });

  const mobileLinks = document.querySelectorAll("#mobile-menu a");
  mobileLinks.forEach(a => a.addEventListener("click", closeMenu));

  window.addEventListener("resize", () => {
    if (window.matchMedia("(min-width: 768px)").matches) closeMenu();
  });

  // 7) Back-to-top
  const backToTop = document.getElementById("backToTop");
  const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  function updateBackToTop(){
    if (!backToTop) return;
    const y = window.pageYOffset || document.documentElement.scrollTop || 0;
    const menuOpen = document.body.classList.contains("menu-open");
    backToTop.classList.toggle("show", y > 100 && !menuOpen);
  }

  function scrollToTop(){
    const behavior = prefersReduced ? "auto" : "smooth";
    try {
      window.scrollTo({ top: 0, behavior });
    } catch {
      window.scrollTo(0, 0);
    }
  }

  if (backToTop) backToTop.addEventListener("click", scrollToTop);

  ["scroll","resize","orientationchange"].forEach(evt => {
    window.addEventListener(evt, updateBackToTop, { passive:true });
  });
  window.addEventListener("load", () => setTimeout(updateBackToTop, 100));
});
